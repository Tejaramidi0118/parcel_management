# Courier Management System - Backend API

A complete backend implementation for the Courier Management System using Node.js, Express, and PostgreSQL.

## Features

- ✅ User Authentication (JWT-based)
- ✅ Role-based Access Control (Customer, Courier, Admin)
- ✅ Parcel Management (CRUD operations)
- ✅ Tracking System
- ✅ Hub Management
- ✅ Vehicle Management
- ✅ City Management
- ✅ Audit Logging
- ✅ Statistics/Dashboard
- ✅ Fare Calculation

## Tech Stack

- **Runtime**: Node.js (v20+)
- **Framework**: Express.js
- **Database**: PostgreSQL 15+
- **Authentication**: JWT (jsonwebtoken)
- **Password Hashing**: bcryptjs
- **Validation**: Zod
- **Environment**: dotenv

## Setup

1. **Install Dependencies**
   ```bash
   npm install
   ```

2. **Database Setup**
   - Create a PostgreSQL database
   - Run the schema.sql file to create all tables
   ```bash
   psql -U your_user -d courier_db -f schema.sql
   ```

3. **Environment Variables**
   - Copy `.env.example` to `.env`
   - Update the database connection string and JWT secret

4. **Run the Server**
   ```bash
   npm run dev
   ```

The server will start on `http://localhost:3000` (or the port specified in `.env`).

## API Endpoints

### Authentication (`/auth`)

- `POST /auth/signup` - User registration
- `POST /auth/login` - User login (returns JWT)
- `GET /auth/me` - Get current user info

### Parcels (`/parcel`)

- `POST /parcel` - Create new parcel (Customer)
- `GET /parcel` - Get all parcels (with filters, Admin sees all)
- `GET /parcel/my` - Get current user's parcels
- `GET /parcel/assigned` - Get assigned parcels (Courier)
- `GET /parcel/:id` - Get parcel by ID
- `PUT /parcel/:id` - Update parcel
- `DELETE /parcel/:id` - Cancel parcel
- `PUT /parcel/:id/status` - Update parcel status
- `POST /parcel/:id/assign` - Assign courier (Admin)

### Tracking (`/tracking`)

- `GET /tracking/:trackingCode` - Get tracking info by code (public)
- `GET /tracking/parcel/:id` - Get tracking events for parcel
- `POST /tracking/events` - Create tracking event

### Hubs (`/hub`)

- `GET /hub` - Get all hubs
- `GET /hub/:id` - Get hub by ID
- `GET /hub/:id/parcels` - Get parcels at hub
- `POST /hub` - Create hub (Admin)
- `PUT /hub/:id` - Update hub (Admin)
- `DELETE /hub/:id` - Delete hub (Admin)

### Vehicles (`/vehicle`)

- `GET /vehicle` - Get all vehicles
- `GET /vehicle/my` - Get current courier's vehicle
- `GET /vehicle/:id` - Get vehicle by ID
- `POST /vehicle` - Create vehicle (Admin)
- `PUT /vehicle/:id` - Update vehicle
- `DELETE /vehicle/:id` - Delete vehicle (Admin)

### Cities (`/city`)

- `GET /city` - Get all cities
- `GET /city/:id` - Get city by ID
- `POST /city` - Create city (Admin)
- `PUT /city/:id` - Update city (Admin)

### Users (`/user`)

- `GET /user` - Get all users (Admin)
- `GET /user/:id` - Get user by ID
- `GET /user/:id/parcels` - Get user's parcels
- `PUT /user/:id` - Update user
- `PUT /user/:id/password` - Change password
- `DELETE /user/:id` - Delete user (Admin)

### Audit Logs (`/audit`)

- `GET /audit` - Get audit logs (Admin)
- `GET /audit/:id` - Get audit log by ID
- `GET /audit/user/:userId` - Get audit logs for user
- `GET /audit/entity/:type/:id` - Get audit logs for entity

### Statistics (`/stats`)

- `GET /stats/dashboard` - Dashboard statistics (Admin)
- `GET /stats/courier` - Courier statistics

### Fare (`/fare`)

- `GET /fare/calculate` - Calculate fare

## Authentication

All protected routes require a JWT token in the Authorization header:

```
Authorization: Bearer <token>
```

## Role-Based Access Control

- **Customer**: Can create parcels, view own parcels, track own parcels
- **Courier**: Can view assigned parcels, update parcel status, view own vehicle
- **Admin**: Full access to all endpoints

## Error Handling

The API uses consistent error responses:

```json
{
  "error": "Error message",
  "details": {} // Optional, for validation errors
}
```

## Database Schema

See `schema.sql` for the complete database schema. The system uses:
- `app_user` - Base user table
- `customer`, `courier`, `admin` - Role-specific tables
- `parcel` - Parcel information
- `parcel_item` - Items in parcels
- `tracking_event` - Tracking history
- `hub` - Distribution hubs
- `vehicle` - Courier vehicles
- `city` - Cities
- `audit_log` - Audit trail

## Development

- The server uses nodemon for auto-reload during development
- All routes are in `src/routes/`
- Middleware is in `src/middleware/`
- Utilities are in `src/utils/`

## Notes

- Tracking codes are UUIDs generated by PostgreSQL
- Passwords are hashed using bcrypt with 10 salt rounds
- JWT tokens expire after 2 hours (configurable)
- The system supports both UUID and string formats for tracking codes

